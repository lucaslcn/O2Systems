/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package telas;

import dao.ListaacaoDAO;
import dao.ListapermissaoDAO;
import dao.UsuarioDAO;
import gema.Gema;
import gema.Mensagens;
import java.util.ArrayList;
import java.util.List;
import java.util.TreeMap;
import javax.swing.JOptionPane;
import javax.swing.JTable;
import negocio.Listaacao;
import negocio.Listapermissao;
import negocio.Usuario;
import persistencia.BasicScreen;
import registros.Atividade;

/**
 *
 * @author XorNOTE
 */
public class GestorUsuarioJIF extends javax.swing.JInternalFrame implements BasicScreen {

    Usuario usuario;
    Usuario usuarioHere;
    TreeMap<Integer, Boolean> can;
    Listapermissao p;
    List<Listapermissao> pList;

    /**
     * Creates new form GestorUsuario
     *
     * @param usuario
     */
    public GestorUsuarioJIF(Usuario usuario, TreeMap<Integer, Boolean> can) {
        initComponents();
        this.usuario = usuario;
        this.can = can;
        limpar();
        jL_msg.setVisible(false);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jTF_codigoUsuario = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        jTF_codigoFuncionario = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jTF_nomeFuncionario = new javax.swing.JTextField();
        jTF_nomeUsuario = new javax.swing.JTextField();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable_permissoes = new javax.swing.JTable();
        btnPermitir = new javax.swing.JButton();
        btnNegar = new javax.swing.JButton();
        btnPermitirTudo = new javax.swing.JButton();
        btnNegatTudo = new javax.swing.JButton();
        btnPermitirTela = new javax.swing.JButton();
        btnNegarTela = new javax.swing.JButton();
        jSeparator1 = new javax.swing.JSeparator();
        jSeparator2 = new javax.swing.JSeparator();
        btnCancelar = new javax.swing.JToggleButton();
        btnPesquisar = new javax.swing.JToggleButton();
        btnDeletar = new javax.swing.JToggleButton();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jL_Total = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        jL_TotalTrue = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        jL_TotalFalse = new javax.swing.JLabel();
        jL_msg = new javax.swing.JLabel();

        setTitle("Gerenciador de Usuário");
        setPreferredSize(new java.awt.Dimension(800, 510));

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Dados do Usuário"));

        jLabel1.setText("Código Usuário");

        jTF_codigoUsuario.setEditable(false);
        jTF_codigoUsuario.setText("007");

        jLabel2.setText("Código Funcionário");

        jTF_codigoFuncionario.setEditable(false);
        jTF_codigoFuncionario.setText("171");

        jLabel3.setText("Login");

        jLabel4.setText("Nome");

        jTF_nomeFuncionario.setEditable(false);
        jTF_nomeFuncionario.setText("Meu Nome aqui");

        jTF_nomeUsuario.setEditable(false);
        jTF_nomeUsuario.setText("meu.acesso.aqui");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jTF_codigoUsuario, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel2)
                        .addGap(18, 18, 18)
                        .addComponent(jTF_codigoFuncionario, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel3)
                        .addGap(20, 20, 20)
                        .addComponent(jTF_nomeUsuario))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel4)
                        .addGap(18, 18, 18)
                        .addComponent(jTF_nomeFuncionario)))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel3)
                            .addComponent(jTF_nomeUsuario, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel4)
                            .addComponent(jTF_nomeFuncionario, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel1)
                            .addComponent(jTF_codigoUsuario, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel2)
                            .addComponent(jTF_codigoFuncionario, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE))))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jTable_permissoes.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Código", "Nome Tela", "Nome Ação", "Situação"
            }
        ));
        jScrollPane1.setViewportView(jTable_permissoes);
        if (jTable_permissoes.getColumnModel().getColumnCount() > 0) {
            jTable_permissoes.getColumnModel().getColumn(0).setMinWidth(60);
            jTable_permissoes.getColumnModel().getColumn(0).setPreferredWidth(60);
            jTable_permissoes.getColumnModel().getColumn(0).setMaxWidth(60);
            jTable_permissoes.getColumnModel().getColumn(0).setHeaderValue("Código");
            jTable_permissoes.getColumnModel().getColumn(1).setMinWidth(267);
            jTable_permissoes.getColumnModel().getColumn(1).setPreferredWidth(267);
            jTable_permissoes.getColumnModel().getColumn(1).setMaxWidth(267);
            jTable_permissoes.getColumnModel().getColumn(1).setHeaderValue("Nome Tela");
            jTable_permissoes.getColumnModel().getColumn(2).setMinWidth(267);
            jTable_permissoes.getColumnModel().getColumn(2).setPreferredWidth(267);
            jTable_permissoes.getColumnModel().getColumn(2).setMaxWidth(267);
            jTable_permissoes.getColumnModel().getColumn(2).setHeaderValue("Nome Ação");
            jTable_permissoes.getColumnModel().getColumn(3).setMinWidth(60);
            jTable_permissoes.getColumnModel().getColumn(3).setPreferredWidth(60);
            jTable_permissoes.getColumnModel().getColumn(3).setMaxWidth(60);
            jTable_permissoes.getColumnModel().getColumn(3).setHeaderValue("Situação");
        }

        btnPermitir.setText("Permitr");
        btnPermitir.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnPermitir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPermitirActionPerformed(evt);
            }
        });

        btnNegar.setText("Negar");
        btnNegar.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnNegar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnNegarActionPerformed(evt);
            }
        });

        btnPermitirTudo.setText("Permitir Tudo");
        btnPermitirTudo.setEnabled(false);
        btnPermitirTudo.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);

        btnNegatTudo.setText("Negar Tudo");
        btnNegatTudo.setEnabled(false);
        btnNegatTudo.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);

        btnPermitirTela.setText("Permitir Tela");
        btnPermitirTela.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnPermitirTela.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPermitirTelaActionPerformed(evt);
            }
        });

        btnNegarTela.setText("Negar Tela");
        btnNegarTela.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnNegarTela.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnNegarTelaActionPerformed(evt);
            }
        });

        btnCancelar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icons/cancel.png"))); // NOI18N
        btnCancelar.setText("Fechar");
        btnCancelar.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnCancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelarActionPerformed(evt);
            }
        });

        btnPesquisar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icons/magnifier.png"))); // NOI18N
        btnPesquisar.setText("Pesquisar");
        btnPesquisar.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnPesquisar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPesquisarActionPerformed(evt);
            }
        });

        btnDeletar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icons/application_delete.png"))); // NOI18N
        btnDeletar.setSelected(true);
        btnDeletar.setText("Arquivar");
        btnDeletar.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        btnDeletar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDeletarActionPerformed(evt);
            }
        });

        jLabel5.setFont(new java.awt.Font("Tahoma", 1, 24)); // NOI18N
        jLabel5.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel5.setText("Gerenciador de Usuário");

        jLabel6.setFont(new java.awt.Font("Tahoma", 1, 10)); // NOI18N
        jLabel6.setText("Total Permissões:");

        jL_Total.setFont(new java.awt.Font("Tahoma", 1, 10)); // NOI18N
        jL_Total.setText("0");

        jLabel8.setFont(new java.awt.Font("Tahoma", 0, 9)); // NOI18N
        jLabel8.setText("Permissões Permitidas:");

        jL_TotalTrue.setFont(new java.awt.Font("Tahoma", 0, 9)); // NOI18N
        jL_TotalTrue.setText("0");

        jLabel10.setFont(new java.awt.Font("Tahoma", 0, 9)); // NOI18N
        jLabel10.setText("Permissões Negadas:");

        jL_TotalFalse.setFont(new java.awt.Font("Tahoma", 0, 9)); // NOI18N
        jL_TotalFalse.setText("0");

        jL_msg.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jL_msg.setText("Por favor, aguarde! Atualizando tabelas...");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 658, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                    .addComponent(btnPermitir, javax.swing.GroupLayout.DEFAULT_SIZE, 100, Short.MAX_VALUE)
                                    .addComponent(btnNegar, javax.swing.GroupLayout.DEFAULT_SIZE, 100, Short.MAX_VALUE)
                                    .addComponent(btnPermitirTudo, javax.swing.GroupLayout.DEFAULT_SIZE, 100, Short.MAX_VALUE)
                                    .addComponent(btnNegatTudo, javax.swing.GroupLayout.DEFAULT_SIZE, 100, Short.MAX_VALUE)
                                    .addComponent(btnPermitirTela, javax.swing.GroupLayout.DEFAULT_SIZE, 100, Short.MAX_VALUE)
                                    .addComponent(btnNegarTela, javax.swing.GroupLayout.DEFAULT_SIZE, 100, Short.MAX_VALUE)
                                    .addComponent(jSeparator1)
                                    .addComponent(jSeparator2)))
                            .addGroup(layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(jLabel6)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(jL_Total)
                                        .addGap(18, 18, 18)
                                        .addComponent(jLabel8)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(jL_TotalTrue)
                                        .addGap(18, 18, 18)
                                        .addComponent(jLabel10))
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(btnCancelar, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(btnPesquisar, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)))
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(jL_msg)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                        .addComponent(btnDeletar, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addComponent(jL_TotalFalse))))
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel5)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 244, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(btnPermitir, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnNegar, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(4, 4, 4)
                        .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, 10, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(4, 4, 4)
                        .addComponent(btnPermitirTudo, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnNegatTudo, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(5, 5, 5)
                        .addComponent(jSeparator2, javax.swing.GroupLayout.PREFERRED_SIZE, 10, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(3, 3, 3)
                        .addComponent(btnPermitirTela, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnNegarTela, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(3, 3, 3)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel10)
                        .addComponent(jL_TotalFalse))
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel8)
                        .addComponent(jL_TotalTrue))
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel6)
                        .addComponent(jL_Total)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 25, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnDeletar, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnCancelar, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnPesquisar, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jL_msg))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnPermitirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPermitirActionPerformed
        jL_msg.setVisible(true);
        int linha = jTable_permissoes.getSelectedRow();
        if (linha >= 0) {

            int id = Integer.parseInt(jTable_permissoes.getValueAt(linha, 0).toString());
            p = new ListapermissaoDAO().consultarId(id);

            String[] oldInfo = auditoria();

            p.setPermissao(true);

            String[] newInfo = auditoria();

            Atividade logAuditoria = autoAuditoria(oldInfo, newInfo);

            if (p != null) {
                jL_msg.setVisible(true);
                String r = new ListapermissaoDAO().update(p, logAuditoria);
                if (r == null) {
                    Mensagens.retornoAcao(Mensagens.salvo("Permitir acesso") + "\n" + jL_msg.getText());
                    atualizaTabela();
                } else {
                    Mensagens.retornoAcao(Mensagens.erroSalvar("Permitir acesso") + Mensagens.mensagemTecnica(r));
                }
            }
        } else {
            Mensagens.retornoAcao(Mensagens.selecioneAlgumItem());
        }
        jL_msg.setVisible(false);
    }//GEN-LAST:event_btnPermitirActionPerformed

    private void btnCancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelarActionPerformed
        int resposta = Mensagens.questionarAcao();
        if (resposta == JOptionPane.NO_OPTION) {

        } else if (resposta == JOptionPane.YES_OPTION) {
            dispose();
        }
    }//GEN-LAST:event_btnCancelarActionPerformed

    private void btnPesquisarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPesquisarActionPerformed
        jL_msg.setVisible(true);
        Usuario k = (Usuario) Gema.pesquisar(new UsuarioDAO());

        if (k != null) {
            this.usuarioHere = k;
            preencher();
        }
        jL_msg.setVisible(false);
    }//GEN-LAST:event_btnPesquisarActionPerformed

    private void btnDeletarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDeletarActionPerformed
//        int resposta = Mensagens.confirmarexclusao();
//        if (resposta == JOptionPane.YES_OPTION) {
//            try {
//                String[] infoOld = auditoria();
//                String[] infoNew = auditoria();
//                Atividade logAuditoria = autoAuditoria(infoOld, infoNew);
//
//                this.exame.setStatus(false);
//                String r;
//                r = new ExameDAO().update(this.exame , logAuditoria);
//                situacaoNovo();
//                if (r == null) {
//                    Mensagens.retornoAcao(Mensagens.arquivado("Exame")); //Acrecentar o resultado da auditoria a msg.
//                    limpar();
//                    situacaoNovo();
//                } else {
//                    Mensagens.retornoAcao(Mensagens.erroArquivado("Exame"));
//
//                }
//            } catch (HibernateException he) {
//                System.out.println(he);
//            }
//        }

        jL_msg.setVisible(!jL_msg.isVisible());
    }//GEN-LAST:event_btnDeletarActionPerformed

    private void btnNegarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnNegarActionPerformed
        jL_msg.setVisible(true);
        int linha = jTable_permissoes.getSelectedRow();
        if (linha >= 0) {

            int id = Integer.parseInt(jTable_permissoes.getValueAt(linha, 0).toString());
            p = new ListapermissaoDAO().consultarId(id);

            String[] oldInfo = auditoria();

            p.setPermissao(false);

            String[] newInfo = auditoria();

            Atividade logAuditoria = autoAuditoria(oldInfo, newInfo);

            if (p != null) {
                String r = new ListapermissaoDAO().update(p, logAuditoria);
                if (r == null) {
                    Mensagens.retornoAcao(Mensagens.salvo("Negar acesso") + "\n" + jL_msg.getText());
                    atualizaTabela();
                } else {
                    Mensagens.retornoAcao(Mensagens.erroSalvar("Permitir acesso") + Mensagens.mensagemTecnica(r));
                }
            }
        } else {
            Mensagens.retornoAcao(Mensagens.selecioneAlgumItem());
        }
        jL_msg.setVisible(false);
    }//GEN-LAST:event_btnNegarActionPerformed

    private void btnPermitirTelaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPermitirTelaActionPerformed
        jL_msg.setVisible(true);
        int linha = jTable_permissoes.getSelectedRow();
        if (linha >= 0) {
            ArrayList<Listapermissao> pList = new ArrayList();
            int idTela = Integer.parseInt(jTable_permissoes.getValueAt(linha, 1).toString());
            List<Listaacao> aList = new ListaacaoDAO().selectWithJoin("Listaacao", "idtela = " + idTela);
            for (Listaacao listaacao : aList) {
                Listapermissao e = (Listapermissao) new ListapermissaoDAO().selectWithJoin("Listapermissao", "idlistaacao = " + listaacao.getIdlistaacao() + " AND idusuario = " + usuarioHere.getIdusuario()).get(0);
                if( e != null ){
                    pList.add( e );
                }
            }
            
            int totalPermissoes = pList.size(), falhas = 0, sucessos = 0;

            for (int i = 0; i < pList.size(); i++) {

                p = pList.get(i);
                String[] oldInfo = auditoria();
                p.setPermissao(true);
                String[] newInfo = auditoria();
                Atividade logAuditoria = autoAuditoria(oldInfo, newInfo);

                String r = new ListapermissaoDAO().update(p, logAuditoria);
                if (r == null) {
                } else {
                    falhas++;
                }
            }
            sucessos = totalPermissoes - falhas;
            String f = "Foi finalizado a ação para permissão das atividade da tela\n"
                    + "Total de permissões encontradas: " + totalPermissoes + "\n"
                    + "Total de ações de sucesso......: " + sucessos + "\n"
                    + "Total de ações com falha.......: " + falhas + "\n";
            Mensagens.retornoAcao(Mensagens.salvo("Permitir acesso") + "\n" + jL_msg.getText() + "\n" + f);
            atualizaTabela();
        } else {
            Mensagens.retornoAcao(Mensagens.selecioneAlgumItem());
        }
        jL_msg.setVisible(false);
    }//GEN-LAST:event_btnPermitirTelaActionPerformed

    private void btnNegarTelaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnNegarTelaActionPerformed
        jL_msg.setVisible(true);
        int linha = jTable_permissoes.getSelectedRow();
        if (linha >= 0) {
            ArrayList<Listapermissao> pList = new ArrayList();
            int idTela = Integer.parseInt(jTable_permissoes.getValueAt(linha, 1).toString());
            List<Listaacao> aList = new ListaacaoDAO().selectWithJoin("Listaacao", "idtela = " + idTela);
            for (Listaacao listaacao : aList) {
                Listapermissao e = (Listapermissao) new ListapermissaoDAO().selectWithJoin("Listapermissao", "idlistaacao = " + listaacao.getIdlistaacao() + " AND idusuario = " + usuarioHere.getIdusuario()).get(0);
                if( e != null ){
                    pList.add( e );
                }
            }
            
            int totalPermissoes = pList.size(), falhas = 0, sucessos = 0;

            for (int i = 0; i < pList.size(); i++) {

                p = pList.get(i);
                String[] oldInfo = auditoria();
                p.setPermissao(false);
                String[] newInfo = auditoria();
                Atividade logAuditoria = autoAuditoria(oldInfo, newInfo);

                String r = new ListapermissaoDAO().update(p, logAuditoria);
                if (r == null) {
                } else {
                    falhas++;
                }
            }
            sucessos = totalPermissoes - falhas;
            String f = "Foi finalizado a ação para permissão das atividade da tela\n"
                    + "Total de permissões encontradas: " + totalPermissoes + "\n"
                    + "Total de ações de sucesso......: " + sucessos + "\n"
                    + "Total de ações com falha.......: " + falhas + "\n";
            Mensagens.retornoAcao(Mensagens.salvo("Permitir acesso") + "\n" + jL_msg.getText() + "\n" + f);
            atualizaTabela();
        } else {
            Mensagens.retornoAcao(Mensagens.selecioneAlgumItem());
        }
        jL_msg.setVisible(false);
    }//GEN-LAST:event_btnNegarTelaActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JToggleButton btnCancelar;
    private javax.swing.JToggleButton btnDeletar;
    private javax.swing.JButton btnNegar;
    private javax.swing.JButton btnNegarTela;
    private javax.swing.JButton btnNegatTudo;
    private javax.swing.JButton btnPermitir;
    private javax.swing.JButton btnPermitirTela;
    private javax.swing.JButton btnPermitirTudo;
    private javax.swing.JToggleButton btnPesquisar;
    private javax.swing.JLabel jL_Total;
    private javax.swing.JLabel jL_TotalFalse;
    private javax.swing.JLabel jL_TotalTrue;
    private javax.swing.JLabel jL_msg;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JSeparator jSeparator2;
    private javax.swing.JTextField jTF_codigoFuncionario;
    private javax.swing.JTextField jTF_codigoUsuario;
    private javax.swing.JTextField jTF_nomeFuncionario;
    private javax.swing.JTextField jTF_nomeUsuario;
    private javax.swing.JTable jTable_permissoes;
    // End of variables declaration//GEN-END:variables

    @Override
    public void preencher() {
        jTF_codigoFuncionario.setText(usuarioHere.getIdfuncionario().getIdfuncionario() + "");
        jTF_codigoUsuario.setText(usuarioHere.getIdusuario() + "");
        jTF_nomeFuncionario.setText(usuarioHere.getIdfuncionario().getIdpessoa().getNomepessoa());
        jTF_nomeUsuario.setText(usuarioHere.getNick());
        atualizaTabela();
    }

    public void atualizaTabela() {
        //new UsuarioDAO().preencherTabelaBusca(jTable_permissoes, "");
        new UsuarioDAO().preencherTabelaPermissao(jTable_permissoes, usuarioHere);
        calculaTotal();
    }

    public void calculaTotal() {
        int total = jTable_permissoes.getRowCount();
        int totalTrue = 0, totalFalse = 0;
        for (int i = 0; i < total; i++) {
            String r = jTable_permissoes.getValueAt(i, 4) + "";
            if (r.equals("Permitido")) {
                totalTrue++;
            } else {
                totalFalse++;
            }
        }

        jL_Total.setText(total + "");
        jL_TotalTrue.setText(totalTrue + "");
        jL_TotalFalse.setText(totalFalse + "");
    }

    @Override
    public void limpar() {
        jTF_codigoFuncionario.setText("");
        jTF_codigoUsuario.setText("");
        jTF_nomeFuncionario.setText("");
        jTF_nomeUsuario.setText("");
    }

    @Override
    public void popular() {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public void situacaoNovo() {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public void situacaoEditar() {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public void situacaoVisualizacao() {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public void permissao() {
        throw new UnsupportedOperationException("Not supported yet."); //To change body of generated methods, choose Tools | Templates.
    }

    @Override
    public String[] auditoria() {
        String[] r
                = {
                    p.getIdlistapermissao() + "",
                    p.getIdusuario().getIdusuario() + "",
                    p.getIdlistaacao().getIdlistaacao() + "",
                    p.getPermissao() + ""
                };
        return r;
    }

    @Override
    public Atividade autoAuditoria(String[] iOld, String[] iNew) {
        Atividade logAuditoria = new Atividade();
        logAuditoria.setInformacaoOld(iOld);
        logAuditoria.setInformacaoNew(iNew);
        logAuditoria.setOnde(Atividade.FROM_GESTOR_USUARIO);
        logAuditoria.setUsuario(usuario);
        return logAuditoria;
    }
}
